<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Figma MCP Bridge</title>
    <style>
      html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
    </style>
  </head>
  <body>
    <script>
      (function () {
        let serverUrl = "http://localhost:8765";
        let pollTimer = null;
        let pollInterval = 600;
        let isPolling = false;

        function log(message) {
          // Visible only in Figma plugin console
          console.log("[figma-mcp]", message);
        }

        async function post(path, body) {
          const res = await fetch(serverUrl + path, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          return res;
        }

        async function poll() {
          if (isPolling) return;
          isPolling = true;
          try {
            const res = await fetch(serverUrl + "/pull");
            if (res.status === 204) {
              // no pending requests
            } else if (res.ok) {
              const msg = await res.json();
              if (msg && msg.type === "request") {
                parent.postMessage({ pluginMessage: msg }, "*");
              }
            }
          } catch (err) {
            log("Poll error: " + err);
          }
          isPolling = false;
          pollTimer = setTimeout(poll, pollInterval);
        }

        window.onmessage = (event) => {
          const msg = event.data.pluginMessage;
          if (!msg) return;

          if (msg.type === "config" && msg.serverUrl) {
            serverUrl = msg.serverUrl;
            if (pollTimer) clearTimeout(pollTimer);
            poll();
            return;
          }

          if (msg.type === "response" || msg.type === "event") {
            post(msg.type === "response" ? "/push" : "/event", msg).catch((err) => {
              log("Post error: " + err);
            });
          }
        };

        poll();
      })();
    </script>
  </body>
</html>
